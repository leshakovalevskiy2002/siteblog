{% extends 'base.html' %}
{% load i18n %}

{% block title %}{{ title }}{% endblock title %}

{% block content %}
    <h1 style="margin-top: 3px;">{% translate "Existing chats" %}</h1>
    <ul class="px-0">
    {% for group in groups %}
        <div class="card mb-3 col-6">
            <div class="card-header">{{ group.name }}</div>
            <div class="card-body" id="{{ group.uuid }}">
              {% if user in group.members.all %}
                <button id="leave-{{ group.uuid }}" class="group_option btn btn-secondary" value="leave_group {{ group.uuid }}">
                    {% translate "Leave" %}
                </button>
                <button id="open-{{ group.uuid }}" class="group_option btn btn-secondary" value="open_group {{ group.uuid }}">
                    {% translate "Open" %}
                </button>
            {% else %}
                <button id="join-{{ group.uuid }}" class="group_option btn btn-secondary" value="join_group {{ group.uuid }}">
                    {% translate "Join" %}
                </button>
            {% endif %}
            </div>
          </div>
    {% endfor %}
    </ul>
{% endblock content %}

{% block script %}
    {% get_current_language as LANGUAGE %}
    <script>
        const protocol = window.location.protocol === "https:" ? "wss" : "ws";
        const base_url = `${window.location.host}`;
        const websocket = new WebSocket(`${protocol}://${base_url}/chat/`);

        websocket.onopen = function (event) {
            console.log("Connection Open")
        }

        websocket.onmessage = function (event) {
            message = JSON.parse(event.data)
            let type = message.type
            let data = message.data

            switch (type) {
                case "leave_group":
                    leave_group_handler(data)
                    break;
                case "join_group":
                    join_group_handler(data)
                    break;
            }
        }

        function leave_group_handler(uuid) {
            var leave_button = document.getElementById(`leave-${uuid}`)
            var open_button = document.getElementById(`open-${uuid}`)
            leave_button.remove()
            open_button.remove()
            var button = `<button id="join-${uuid}" class="group_option btn btn-secondary" value="join_group ${uuid}">{% trans "Join" %}</button>`
            var dev_body = document.getElementById(uuid)
            dev_body.innerHTML += button
            add_event_to_all_buttons()
        }

        function join_group_handler(uuid) {
            var leave_button = document.getElementById(`join-${uuid}`)
            leave_button.remove()
            var button = `<button id="leave-${uuid}" class="group_option btn btn-secondary" value="leave_group ${uuid}">{% trans "Leave" %}</button>`
            var open_button = `<button id="open-${uuid}" class="group_option btn btn-secondary" value="open_group ${uuid}">{% trans "Open" %}</button>`

            var dev_body = document.getElementById(uuid)
            dev_body.innerHTML += button + " " + open_button;
            add_event_to_all_buttons()
        }

        function add_event_to_all_buttons() {
            const keys = document.querySelectorAll('.group_option');
            keys.forEach(item => {
                    item.addEventListener('click', send_event_message)
                }
            )
        }

        function send_event_message(event) {
            const {target} = event;
            group = target.value.split(" ")
            group_uuid = group[1]
            action = group[0] // Leave or Join or Open
            if (action == "open_group") {
                const lang = "{{ LANGUAGE }}";
                const baseUrl = "{{ request.get_host }}";
                const groupPath = {
                    en: "chat/groups",
                    ru: "чат/группы",
                    be: "гутарка/групы"
                };

                const path = groupPath[lang]
                const url = `${window.location.protocol}//${base_url}/${lang}/${path}/${group_uuid}/`;
                window.location.replace(url);
            }
            else {
                let data = {
                    "type": action,
                    "data": group_uuid,
                }
                websocket.send(JSON.stringify(data))
            }
        }

        add_event_to_all_buttons()

    </script>
{% endblock script %}